# docker Private Registry の認証機能

Docker Private Registry には、以下の３つの認証機能が用意されている

- silly
- token
- htpasswd

これらについて情報をまとめてみる

## silly

コレは基本的に開発用途向けとして提供されている

HTTP リクエストの中に `Authorization` が存在するかのみを確認する。  
一方でヘッダの内容については確認しないとあるので、多分存在の有無だけでチェックをしているはず。  
（含まれていればそれでOKと判断するっぽい）  

なお、ヘッダが存在しなければ、強制的に拒否することになる

## token

トークンをベースとした認証を行うことができる。  
V2 から追加された認証の仕組みであり、認証の仕組みをレジストリから独立させられるのが便利な所。  

有名ドコロだと、Cesanta の docker_auth が有名か（自分も使ったことがある）。  
設定する時は、以下のパラメーを指定する必要がある。  


私はいつもコンテナとしてレジストリを立てるので、そのときに指定するオプションもメモしておく  
ちなみに token 認証を指定する場合は `-e REGISTRY_AUTH=token` ってのをつけておけばいい。  

| パラメータ        | 必須か否か | 説明 | registry コンテナ利用時のオプション指定 |
|-------------------|------------|------|-----------------------------------------|
| realm             | 必須       | 認証のレルム | `-e REGISTRY_AUTH_TOKEN_REALM=https://172.16.1.100:5001/auth` |
| service           | 必須       | 認証されたサービス | `-e REGISTRY_AUTH_TOKEN_SERVICE="Docker registry"` |
| issuer            | 必須       | トークン発行者の名前，トークンの中にはこの文字列が必ず含まれることになる | `-e REGISTRY_AUTH_TOKEN_ISSUER="Auth Service"` |
| rootcertbundle    | 必須       | ルート証明書の絶対パス | `-e REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE=/ssl/server.pem` |
| autoredirect      | N/A        | true or false， true にすると `/auth/token/` がヘッダに登録される |  |



## htpasswd
バックエンドの認証に Apache の httpd ファイルを用いたベーシック認証。

`bcrypt` 形式のパスワードのみがサポートされている。  
ちなみに htpasswsd ファイルは起動時に読み込まれ、ファイルが無効なものだったら起動自体できない仕組みとなっている
























# 参考URL
- [Docker-docs-ja Apache を認証プロキシとして使う](http://docs.docker.jp/v1.11/registry/recipes/apache.html)
- [上記の原本]( https://docs.docker.com/registry/recipes/apache/ )
- [Docker-docs-ja Auth]( http://docs.docker.jp/registry/configuration.html#auth )
- [上記の原本]( https://docs.docker.com/registry/configuration/ )

- [token認証の付け方]( https://www.itmedia.co.jp/enterprise/articles/1710/02/news018_3.html )

