# 構成図

```
       +----------------------------------------------------------+
       |    +----------+        +------------+                    |
       |    | KeyCloak |        | Service    |                    |
       |    |          |        |   Provider |                    |
       |    +----+-----+        +---+--------+                    |
       |         | 172.17.0.3       | 172.17.0.3                  |
       |         |                  |                             |
       |    -----+-------+----------+---------- 172.17.0.0/16     |
       |                 |                                        |
       |                 | 172.17.0.1                             |
       |         +-------+-------+                                |
       |         | Docker engine |                                |
       |         +---------------+                                |
       |                                                          |
       +------------------+---------------------------------------+
                          | 192.168.122.153(KVM 仮想マシン)
                          |
                          |
                          | 192.168.122.1(KVM 仮想化ホスト)
                     +----+-----+
                     | KVM host |
                     +----------+
```



KVM ホストからは、以下のコマンドを実行する。
会社と同じように SSH 経由で X window を飛ばせるようにしておく。
```
$ ssh kanamaru@192.168.122.153 -X
```





# Keycloak をコンテナとして配備

以下のコマンドを実行。
```
$ docker run -d  \
   -p 8080:8080 \
   -e KEYCLOAK_USER=admin \
   -e KEYCLOAK_PASSWORD=admin \
   --name kana-keycloak \
   jboss/keycloak
```

その後、docker ホスト上で firefox を起動し、アクセスしてみる。



#_Keycloak に SP を設定


ログイン後、clients にて[新規作成]

```
Client ID: test
Valid Redirect URIs: http://172.17.0.1:8081/secure
```



```
OIDCProviderMetadataURL       http://172.17.0.1:8080/auth/realms/master/.well-known/openid-configuration
OIDCClientID                  test
OIDCClientSecret              9f0de788-2c4f-4ae0-a141-405ce4c865e2
OIDCResponseType              code
OIDCScope                     "openid"
OIDCSSLValidateServer         Off
OIDCProviderTokenEndpointAuth client_secret_basic

OIDCRedirectURI               http://172.17.0.1:8081/secure
OIDCCryptoPassphrase          passphrase
OIDCPreservePost              On

<Location /secure>
   AuthType         openid-connect
   Require          valid-user
</Location>
```














